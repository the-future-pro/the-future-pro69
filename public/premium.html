<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Premium</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .wrap { max-width: 720px; margin: 24px auto; padding: 16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="email"]{ padding:8px; min-width:260px; }
    button{ padding:8px 12px; cursor:pointer; }
    .muted{ opacity:.8; font-size:14px; }
    .ok{ color:#6ade8a; }
    .err{ color:#ff7070; }
    nav a{ margin-right:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="muted">
      <a href="/">Home</a>
      <a href="/gen-image.html">Image Gen</a>
      <a href="/gen-video.html">Video Gen</a>
      <a href="/login-demo.html">Login Demo</a>
    </nav>

    <h1>Premium</h1>
    <p class="muted">
      Pasul 1: login • Pasul 2: verificare vârstă (mock) • Pasul 3: abonare (mock).<br/>
      După ce ești abonat, poți accesa conținut protejat (ex: media semnată).
    </p>

    <div class="row" style="margin:12px 0 8px;">
      <input id="email" type="email" placeholder="email" />
      <button onclick="doLogin()">Login</button>
      <button onclick="mockAge()">Mock Verify Age</button>
      <button onclick="mockSubscribe()">Mock Subscribe</button>
    </div>

    <div id="msg" class="muted">Status: &mdash;</div>

    <hr style="margin:20px 0; opacity:.2;">

    <h3>Test conținut protejat</h3>
    <p class="muted">Acest buton cere un URL semnat (necesită <i>age_verified</i> + <i>subscribed</i>).</p>
    <button onclick="getSigned()">Obține URL semnat</button>
    <div id="signed" class="muted" style="margin-top:8px;"></div>
  </div>

  <script>
    const msg = (t, cls='') => {
      const el = document.getElementById('msg');
      el.className = 'muted ' + cls;
      el.textContent = 'Status: ' + t;
    };

    async function api(path, method='POST', body) {
      try {
        const res = await fetch(path, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: body ? JSON.stringify(body) : undefined
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || res.statusText);
        return data;
      } catch (e) {
        throw e;
      }
    }

    async function doLogin() {
      const email = document.getElementById('email').value.trim();
      if (!email) return msg('Introdu un email', 'err');
      try {
        const r = await api('/api/login', 'POST', { email });
        msg('Logat ca: ' + (r.user?.email || email), 'ok');
      } catch (e) {
        msg(e.message || 'Eroare login', 'err');
      }
    }

    async function mockAge() {
      try {
        await api('/api/verify-age/mock');
        msg('Vârsta verificată (mock)', 'ok');
      } catch (e) {
        if (/Not logged in/i.test(e.message)) {
          msg('Nu ești logat. Fă mai întâi login.', 'err');
        } else {
          msg(e.message || 'Eroare verify-age', 'err');
        }
      }
    }

    async function mockSubscribe() {
      try {
        await api('/api/subscribe/mock');
        msg('Abonat (mock) activat', 'ok');
      } catch (e) {
        if (/Not logged in/i.test(e.message)) {
          msg('Nu ești logat. Fă mai întâi login.', 'err');
        } else {
          msg(e.message || 'Eroare subscribe', 'err');
        }
      }
    }

    async function getSigned() {
      try {
        const r = await api('/api/media/sign', 'POST', { path: '/demo/ai2.jpg' });
        document.getElementById('signed').innerHTML =
          '<span class="ok">OK:</span> ' +
          '<a href="' + r.url + '" target="_blank" rel="noopener">' + r.url + '</a>';
        msg('URL semnat generat', 'ok');
      } catch (e) {
        msg(e.message || 'Eroare semnare media', 'err');
        document.getElementById('signed').textContent = '';
      }
    }
  </script>
</body>
</html>
